<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>XP11 Pro Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
        /* 针对 iPhone 15 灵动岛和底栏优化 */
        body { background: #0f172a; touch-action: none; -webkit-user-select: none; }
        .slider-vertical { -webkit-appearance: slider-vertical; width: 60px; height: 200px; }
    </style>
</head>
<body class="text-slate-200 font-sans">

    <div class="pt-12 pb-4 px-6 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
        <h1 class="text-lg font-bold text-orange-400">XP11 REMOTE</h1>
        <div id="status" class="text-xs px-2 py-1 rounded bg-red-900">未连接</div>
    </div>

    <div class="grid grid-cols-4 gap-2 p-4 bg-slate-900">
        <button onclick="send('AP', 'servos_on')" class="bg-slate-700 active:bg-orange-500 p-3 rounded text-xs">AP Master</button>
        <button onclick="send('AP', 'hldg')" class="bg-slate-700 active:bg-blue-500 p-3 rounded text-xs">HDG</button>
        <button onclick="send('AP', 'alt_hold')" class="bg-slate-700 active:bg-blue-500 p-3 rounded text-xs">ALT</button>
        <button onclick="send('AP', 'speed')" class="bg-slate-700 active:bg-blue-500 p-3 rounded text-xs">SPD</button>
    </div>

    <div class="flex justify-around items-center h-64 mt-4">
        <div class="flex flex-col items-center">
            <div id="joystick" class="w-40 h-40 bg-slate-800 rounded-full border-2 border-slate-700 relative"></div>
            <span class="text-[10px] mt-2 text-slate-500">YOKE (PITCH/ROLL)</span>
        </div>

        <div class="flex flex-col items-center">
            <input type="range" class="slider-vertical" min="0" max="1" step="0.01" value="0" oninput="send('THR', this.value)">
            <span class="text-[10px] mt-2 text-slate-500">THROTTLE</span>
        </div>
    </div>

    <div class="p-4 mt-4 mx-4 bg-black rounded-lg border border-slate-700 grid grid-cols-5 gap-1">
        <div class="col-span-5 text-green-500 font-mono text-[10px] mb-2 px-1">FMC快速指令</div>
        <button onclick="send('FMC', 'DIR')" class="bg-slate-800 p-2 text-[10px]">DIR</button>
        <button onclick="send('FMC', 'DEP')" class="bg-slate-800 p-2 text-[10px]">DEP</button>
        <button onclick="send('FMC', 'ARR')" class="bg-slate-800 p-2 text-[10px]">ARR</button>
        <button onclick="send('FMC', 'LEGS')" class="bg-slate-800 p-2 text-[10px]">LEGS</button>
        <button onclick="send('FMC', 'EXEC')" class="bg-orange-900 p-2 text-[10px] font-bold">EXEC</button>
    </div>

    <script>
        // 【核心修改点】把这里换成你电脑的真实 IP
        const PC_IP = "26.240.129.254"; 
        const socket = new WebSocket(`ws://${PC_IP}:8080`);

        socket.onopen = () => {
            document.getElementById('status').innerText = "已连接";
            document.getElementById('status').className = "text-xs px-2 py-1 rounded bg-green-900";
        };

        // 统一发送函数
        function send(type, val) {
            if(socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({type, val}));
                if (window.navigator.vibrate) window.navigator.vibrate(10); // iPhone 触感反馈
            }
        }

        // 初始化摇杆
        const joy = nipplejs.create({
            zone: document.getElementById('joystick'),
            mode: 'static',
            position: {left: '50%', top: '50%'},
            color: '#fb923c'
        });

        joy.on('move', (evt, data) => {
            // 限制发送频率，防止卡死
            throttleSend('AXIS', {
                x: data.vector.x,
                y: data.vector.y
            });
        });

        joy.on('end', () => send('AXIS', {x: 0, y: 0}));

        let lastSend = 0;
        function throttleSend(type, val) {
            const now = Date.now();
            if(now - lastSend > 50) { // 50ms 发送一次
                send(type, val);
                lastSend = now;
            }
        }
    </script>
</body>
</html>
