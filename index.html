<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>XP11 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; margin: 0; padding: 0; touch-action: none; overflow: hidden; }
        .header { padding: 50px 20px 20px; background: #1e293b; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        .status { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #991b1b; color: #f87171; }
        .status.on { background: #064e3b; color: #34d399; }
        .mcp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; background: #0f172a; }
        .btn { background: #334155; border: none; color: white; padding: 15px 0; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .btn:active { background: #475569; }
        .val { font-family: monospace; color: #fb923c; font-size: 12px; text-align: center; margin-bottom: 5px; }
        .control-area { display: flex; justify-content: space-around; align-items: center; height: 250px; }
        #joy-zone { width: 180px; height: 180px; background: rgba(30, 41, 59, 0.5); border-radius: 50%; border: 2px solid #334155; position: relative; }
        .thr-container { display: flex; flex-direction: column; align-items: center; }
        input[type=range] { -webkit-appearance: slider-vertical; width: 40px; height: 180px; background: #1e293b; }
        .footer { margin: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 15px; border: 1px solid #1e293b; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; }
        .label { font-size: 9px; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        .active-green { background-color: #16a34a !important; box-shadow: 0 0 10px #16a34a; }
    </style>
</head>
<body>
    <div class="header">
        <span style="color:#fb923c; font-weight:bold;">XP11 REMOTE PRO</span>
        <div id="status" class="status">未连接</div>
    </div>

    <div class="mcp-grid">
        <div><div class="val" id="lbl-ap">OFF</div><button id="btn-ap" class="btn" style="width:100%" onclick="toggleAP()">MASTER</button></div>
        <div><div class="val" id="val-hdg">000</div><button class="btn" style="width:100%" ontouchstart="startAdj(event,'hdg',1)" ontouchend="stopAdj()">HDG</button></div>
        <div><div class="val" id="val-alt">05000</div><button class="btn" style="width:100%" ontouchstart="startAdj(event,'alt',100)" ontouchend="stopAdj()">ALT</button></div>
        <div><div class="val" id="val-spd">250</div><button class="btn" style="width:100%" ontouchstart="startAdj(event,'spd',1)" ontouchend="stopAdj()">SPD</button></div>
    </div>

    <div class="control-area">
        <div id="joy-zone"></div>
        <div class="thr-container">
            <input type="range" min="0" max="1" step="0.01" value="0" oninput="send('THR', this.value)">
            <div class="label" style="margin-top:10px">THROTTLE</div>
        </div>
    </div>

    <div class="footer">
        <div><div class="label">Gear</div><div id="gear-box" style="width:30px;height:15px;background:#334155;margin:auto;border-radius:2px;" onclick="toggleGear()"></div></div>
        <div><div class="label">Flaps</div><div style="color:#22c55e;font-size:12px;font-family:monospace;">UP</div></div>
        <div><div class="label">Trim</div><div style="height:4px;background:#334155;border-radius:2px;position:relative;"><div style="position:absolute;left:50%;width:2px;height:100%;background:#fb923c;"></div></div></div>
    </div>

    <script>
        const PC_IP = "192.168.1.11"; 
        const socket = new WebSocket(`ws://${PC_IP}:8080`);
        let state = { ap: false, hdg: 0, alt: 5000, spd: 250, gear: true };
        let adjInt = null;

        socket.onopen = () => {
            const s = document.getElementById('status');
            s.innerText = "已连接"; s.className = "status on";
        };

        function send(type, val) { if(socket.readyState === 1) socket.send(JSON.stringify({type, val})); }

        function toggleAP() {
            state.ap = !state.ap;
            document.getElementById('btn-ap').classList.toggle('active-green');
            document.getElementById('lbl-ap').innerText = state.ap ? "ENGAGED" : "OFF";
            send('AP_MASTER', state.ap);
        }

        function toggleGear() {
            state.gear = !state.gear;
            document.getElementById('gear-box').style.backgroundColor = state.gear ? '#16a34a' : '#991b1b';
            send('GEAR', state.gear ? 1 : 0);
        }

        function startAdj(e, type, step) {
            const rect = e.target.getBoundingClientRect();
            const isPlus = (e.touches[0].clientX - rect.left) > rect.width / 2;
            const delta = isPlus ? step : -step;
            const run = () => {
                if(type === 'hdg') state.hdg = (state.hdg + (isPlus?1:359)) % 360;
                else state[type] = Math.max(0, state[type] + delta);
                document.getElementById('val-'+type).innerText = state[type].toString().padStart(type==='alt'?5:3,'0');
                send('SET_VALUE', {type, value: state[type]});
            };
            run(); adjInt = setInterval(run, 120);
        }
        function stopAdj() { clearInterval(adjInt); }

        let manager = nipplejs.create({ zone: document.getElementById('joy-zone'), mode: 'static', position: {left: '50%', top: '50%'}, color: 'white', size: 120 });
        manager.on('move', (e, d) => send('AXIS', {x: d.vector.x, y: d.vector.y}));
        manager.on('end', () => send('AXIS', {x: 0, y: 0}));
    </script>
</body>
</html>
